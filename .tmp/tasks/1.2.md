# Task 1.2: Docker Compose環境構築（ドキュメント）

## 概要（目的）
- 開発・本番・テストで共通のコンテナ実行基盤を用意し、DB/キャッシュやアプリの起動・停止を統一手順で行えるようにする。
- ここでは実装は行わず、必要なファイルとインタフェース（スケルトン）のみ定義する。

## スコープ（本タスクで対象とするもの）
- `PostgreSQL` と `Redis` の開発用構成
- アプリ用 `Dockerfile` の雛形
- ルーティング/プロキシ用 `Caddyfile` の雛形
- 開発/本番/テスト向けの `docker compose` 構成ファイルの雛形
- `.gitignore` におけるDocker関連の基本除外

## 成果物（作成予定ファイル）
- `docker/compose.development.yml`
- `docker/compose.production.yml`
- `docker/compose.test.yml`
- `docker/Dockerfile`
- `docker/Caddyfile`
- `.gitignore`（Docker関連の除外を追記）

## インタフェース（スケルトン：コードは英語、実装なし）

開発用 Compose（PostgreSQL + Redis を起動、アプリは任意で追加）

```yaml
# docker/compose.development.yml
version: "3.9"
services:
  db:
    image: postgres:16
    # environment: [POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB]
    # ports: ["5432:5432"]
    # volumes: ["dev_db_data:/var/lib/postgresql/data"]
  cache:
    image: redis:7
    # ports: ["6379:6379"]
  app:
    # build: ../ (see docker/Dockerfile)
    # env_file: ../.env.development
    # depends_on: [db, cache]
volumes:
  dev_db_data:
```

本番用 Compose（アプリのみを前提、DB/Redisはマネージド想定 or 別クラスタ）

```yaml
# docker/compose.production.yml
version: "3.9"
services:
  app:
    # image: ghcr.io/org/app:tag
    # env_file: ../.env.production
    # ports: ["8080:8080"]
  proxy:
    image: caddy:2
    # volumes: ["./Caddyfile:/etc/caddy/Caddyfile:ro"]
    # depends_on: [app]
```

テスト用 Compose（CI向け、最小構成）

```yaml
# docker/compose.test.yml
version: "3.9"
services:
  db:
    image: postgres:16
    # environment: minimal test credentials
  cache:
    image: redis:7
```

アプリ Dockerfile（マルチステージの雛形）

```dockerfile
# docker/Dockerfile
# syntax=docker/dockerfile:1

# ---- builder ----
FROM node:22-alpine AS builder
# WORKDIR /app
# COPY package.json pnpm-lock.yaml ./
# RUN corepack enable && pnpm install --frozen-lockfile
# COPY . .
# RUN pnpm -w build

# ---- runner ----
FROM node:22-alpine AS runner
# WORKDIR /app
# ENV NODE_ENV=production
# COPY --from=builder /app/dist ./dist
# EXPOSE 8080
# CMD ["node", "dist/server.js"]
```

Caddyfile（リバースプロキシの雛形）

```caddyfile
# docker/Caddyfile
:80 {
  # reverse_proxy app:8080
  # encode gzip
  # header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
}
```

`.gitignore` へ追記する想定のエントリ（説明のみ、実際の追記は別差分で対応）

```gitignore
# Docker related (examples)
# /docker/*.env
# /docker/.data/
# /docker/**/node_modules/
# /docker/**/dist/
```

## 完了条件（ドキュメント段階）
- 上記ファイル群の「雛形と配置方針」が合意されていること。
- 実実装に先立ち、Compose・Dockerfile・Caddyfileの責務分担が明確になっていること。

## 非スコープ（ここでは扱わない）
- 具体的なイメージタグ・環境変数・ボリュームの実装
- セキュリティ/運用チューニングの詳細（本番導入時に別タスクで対応）
