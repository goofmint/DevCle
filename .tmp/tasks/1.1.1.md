# Task 1.1.1 ドキュメント: docker-compose.yml 作成

## 概要
- 目的: 開発環境を `docker-compose up -d` で一括起動できるようにする。
- 範囲: `nginx`, `web` (Remix), `worker`, `db` (PostgreSQL), `redis`, `posthog` のサービス定義とネットワーク/ボリュームの骨子。
- 実装方針: この段階では「構成とインタフェース」のみを定義し、具体的なイメージタグやチューニングは含めない。

## 完了条件
- `docker-compose.yml` に各サービスの論理的な構成（キー、依存関係、ポート、ボリューム、環境変数のインタフェース）が定義されている。
- `.env.example` に必要な環境変数名の一覧が記載されている（値は未設定）。
- `web`→`nginx`→`http://localhost` へ転送する基本ルーティングの方針が説明されている。

## インタフェース（YAML スケルトン）
以下は「構成の形」を示すためのスケルトンです。具体的な値や最適化は実装フェーズで設定します。

```yaml
version: "3.9"

services:
  nginx:
    # reverse proxy to web:8080
    image: <TBD>
    ports:
      - "80:80"
    depends_on:
      - web
    volumes:
      - nginx-conf:/etc/nginx/conf.d:ro

  web:
    # Remix application
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "8080:8080"
    depends_on:
      - db
      - redis

  worker:
    # Background jobs (same image as web)
    build:
      context: .
      dockerfile: Dockerfile
    command: ["pnpm", "start:worker"]
    env_file:
      - .env
    depends_on:
      - db
      - redis

  db:
    # PostgreSQL 15+
    image: <TBD>
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - db-data:/var/lib/postgresql/data

  redis:
    image: <TBD>
    volumes:
      - redis-data:/data

  posthog:
    image: <TBD>
    depends_on:
      - db
      - redis
    environment:
      # leave API-related values blank in .env.example
      SITE_URL: ${POSTHOG_SITE_URL}

volumes:
  db-data: {}
  redis-data: {}
  nginx-conf: {}

networks:
  default:
    name: devcle
```

## 環境変数（.env.example に記載）
- `DATABASE_URL`
- `REDIS_URL`
- `SESSION_SECRET`
- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `POSTHOG_SITE_URL`
- `POSTHOG_API_KEY`（Phase 4 で使用予定／値は未設定のまま）

## nginx ルーティング方針（説明のみ）
- `nginx` は `web:8080` へリバースプロキシする。
- 静的アセットは `web` コンテナの公開ディレクトリを配信対象にする。
- 実装時に `nginx.conf` をボリュームでマウント（`nginx-conf`）し、`/` を `web:8080` に転送。

## 非対象（このチェックボックスでは行わない）
- 具体的な Docker イメージの選定・タグ固定
- `Dockerfile` の最適化（multi-stage build 等）
- `nginx.conf` の詳細実装
- ヘルスチェックや再起動ポリシーのチューニング

## 動作確認の観点（実装後に行う）
- `docker-compose config` が成功し構文が正しいこと。
- `.env` を用意した上で `docker-compose up -d` がエラーなく開始すること。
- `nginx`→`web` のプロキシ経路で `http://localhost` に到達できること（初期画面想定）。

