# Task 1.1.1 ドキュメント: docker-compose.yml 作成

## 概要
- 目的: 開発/本番共通の `nginx.conf` を用いながら、`docker-compose` を本番ベース + 開発用上書きで構成し、開発環境では `devcle.test` ドメインと mkcert 証明書を使用する。
- 範囲: `nginx`, `web` (Remix), `worker` をベース（本番）とし、開発用オーバーライドで `db` (PostgreSQL), `redis` を追加。`posthog` は後続フェーズ。
- 実装方針: この段階では「構成とインタフェース」のみを定義し、具体的なイメージタグやチューニングは含めない。

## 完了条件
- `docker-compose.yml` に各サービスの論理的な構成（キー、依存関係、ポート、ボリューム、環境変数のインタフェース）が定義されている。
- `.env.example` に必要な環境変数名の一覧が記載されている（値は未設定）。
- `web`→`nginx`→`http://localhost` へ転送する基本ルーティングの方針が説明されている。

## インタフェース（YAML スケルトン）
以下は「構成の形」を示すためのスケルトンです。具体的な値や最適化は実装フェーズで設定します。

### 本番ベース: `docker-compose.yml`

```yaml
version: "3.9"

services:
  nginx:
    # reverse proxy + TLS termination (common nginx.conf)
    image: <TBD>
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
    volumes:
      # nginx.conf をマウント（共通ファイル）
      - nginx-conf:/etc/nginx/conf.d:ro
      # 本番では証明書を /etc/nginx/devcle.crt /etc/nginx/devcle.key として供給（方法はインフラ側で調達）
      - nginx-cert:/etc/nginx/devcle.crt:ro
      - nginx-key:/etc/nginx/devcle.key:ro

  web:
    # Remix application
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "8080:8080"
    environment:
      # 本番は外部の DB/Redis を参照
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}

  worker:
    # Background jobs (same image as web)
    build:
      context: .
      dockerfile: Dockerfile
    command: ["pnpm", "start:worker"]
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}

volumes:
  nginx-conf: {}
  nginx-cert: {}
  nginx-key: {}

networks:
  default:
    name: devcle
```

### 開発オーバーライド: `docker-compose.dev.yml`

```yaml
services:
  nginx:
    # mkcert で作成した devcle.test 用の証明書をマウント
    volumes:
      - ./nginx:/etc/nginx/conf.d:ro         # 同一 nginx.conf を使う
      - ./certs/devcle.test+3.pem:/etc/nginx/devcle.crt:ro
      - ./certs/devcle.test+3-key.pem:/etc/nginx/devcle.key:ro

  web:
    # 開発ではローカルの db/redis に依存
    depends_on:
      - db
      - redis
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/app
      REDIS_URL: redis://redis:6379

  worker:
    depends_on:
      - db
      - redis
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/app
      REDIS_URL: redis://redis:6379

  db:
    image: <TBD>
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - db-data:/var/lib/postgresql/data

  redis:
    image: <TBD>
    volumes:
      - redis-data:/data

volumes:
  db-data: {}
  redis-data: {}
```

```yaml
version: "3.9"

services:
  nginx:
    # reverse proxy to web:8080
    image: <TBD>
    ports:
      - "80:80"
    depends_on:
      - web
    volumes:
      - nginx-conf:/etc/nginx/conf.d:ro

  web:
    # Remix application
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "8080:8080"
    depends_on:
      - db
      - redis

  worker:
    # Background jobs (same image as web)
    build:
      context: .
      dockerfile: Dockerfile
    command: ["pnpm", "start:worker"]
    env_file:
      - .env
    depends_on:
      - db
      - redis

  db:
    # PostgreSQL 15+
    image: <TBD>
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - db-data:/var/lib/postgresql/data

  redis:
    image: <TBD>
    volumes:
      - redis-data:/data

  posthog:
    image: <TBD>
    depends_on:
      - db
      - redis
    environment:
      # leave API-related values blank in .env.example
      SITE_URL: ${POSTHOG_SITE_URL}

volumes:
  db-data: {}
  redis-data: {}
  nginx-conf: {}

networks:
  default:
    name: devcle
```

## 環境変数（.env.example に記載）
- `DATABASE_URL`
- `REDIS_URL`
- `SESSION_SECRET`
- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `POSTHOG_SITE_URL`
- `POSTHOG_API_KEY`（Phase 4 で使用予定／値は未設定のまま）

## nginx ルーティング/SSL 方針（説明のみ）
- `nginx` は `web:8080` へリバースプロキシする。
- 静的アセットは `web` コンテナの公開ディレクトリを配信対象にする。
- `nginx.conf` は本番・開発共通ファイルを使用し、以下のパスで証明書を参照する。
  - `ssl_certificate /etc/nginx/devcle.crt;`
  - `ssl_certificate_key /etc/nginx/devcle.key;`
- 本番: 上記パスに本番証明書がマウントされる想定（`docker-compose.yml` の `nginx-cert`/`nginx-key` で供給）。
- 開発: mkcert で生成した `devcle.test+3.pem` / `devcle.test+3-key.pem` を `docker-compose.dev.yml` で上記パスにマウント。

## 非対象（このチェックボックスでは行わない）
- 具体的な Docker イメージの選定・タグ固定
- `Dockerfile` の最適化（multi-stage build 等）
- `nginx.conf` の詳細実装
- ヘルスチェックや再起動ポリシーのチューニング

## 動作確認の観点（実装後に行う）
- `mkcert` により証明書が作成されていること。
- `docker compose -f docker-compose.yml -f docker-compose.dev.yml config` が成功し構文が正しいこと。
- `.env` を用意した上で `docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d` で起動できること。
- `https://devcle.test` にアクセスし、自己署名ではないローカル CA による証明書が認識されること（mkcert）。
- 本番は `docker-compose.yml` 単独で動作し、`DATABASE_URL`/`REDIS_URL` が外部エンドポイントを指すこと。

## mkcert 証明書作成手順（説明のみ）
```bash
mkcert -install
mkcert devcle.test "*.devcle.test" localhost 127.0.0.1 ::1
# 例: devcle.test+3.pem と devcle.test+3-key.pem が生成される
# リポジトリでは ./certs/ 配下（未追跡）に配置して docker-compose.dev.yml でマウント
```
