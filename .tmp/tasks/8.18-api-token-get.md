# Task 8.18: APIãƒˆãƒ¼ã‚¯ãƒ³è©³ç´°å–å¾—APIã®å®Ÿè£…

## æ¦‚è¦

`GET /api/tokens/:id` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã€APIãƒˆãƒ¼ã‚¯ãƒ³ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ç›®çš„

- ç®¡ç†ç”»é¢ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨çŠ¶æ³ï¼ˆæœ€çµ‚ä½¿ç”¨æ—¥æ™‚ã€æœ‰åŠ¹æœŸé™ï¼‰ã‚’ç¢ºèªã™ã‚‹ãŸã‚
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆactive/expired/revokedï¼‰ã‚’åˆ¤å®šã™ã‚‹ãŸã‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

- ğŸš¨ **é‡è¦**: ç”Ÿãƒˆãƒ¼ã‚¯ãƒ³ã¯çµ¶å¯¾ã«è¿”ã•ãªã„ï¼ˆtokenPrefixã®ã¿ï¼‰
- èªè¨¼å¿…é ˆï¼šrequireAuth()ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼šRLSï¼ˆRow Level Securityï¼‰ã§ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
- å­˜åœ¨ã—ãªã„ãƒˆãƒ¼ã‚¯ãƒ³ï¼š404ã‚¨ãƒ©ãƒ¼

### å†…éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã¦ã¯ã„ã‘ãªã„ï¼‰:
- `tokenHash`: SHA256ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆæ¤œè¨¼ç”¨ã®ç§˜å¯†æƒ…å ±ã€ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã§ã®ã¿ä½¿ç”¨ï¼‰
- ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå®Ÿè£…æ™‚ã«è¿½åŠ ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å†…éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
HTTP Request (GET /api/tokens/:id)
  â†“
Resource Route (app/routes/api.tokens_.$id.ts)
  â†“ requireAuth() â†’ user.tenantId
  â†“
Service Layer (services/token.service.ts)
  â†“ withTenantContext(tenantId, async (tx) => { ... })
  â†“
Drizzle ORM
  â†“
PostgreSQL + RLS
```

## å®Ÿè£…å†…å®¹

### 1. ã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼ˆ`core/services/token.service.ts`ï¼‰

#### 1.1 å‹å®šç¾©

```typescript
/**
 * Token detail response type (without plain text token and internal fields)
 *
 * Excludes:
 * - token: Plain text token (never stored in DB)
 * - tokenHash: SHA256 hash for verification (internal use only)
 */
export type TokenDetail = Omit<typeof schema.apiTokens.$inferSelect, 'tokenHash'> & {
  status: 'active' | 'expired' | 'revoked';
};
```

#### 1.2 é–¢æ•°ï¼šgetToken()

```typescript
/**
 * Get API token detail by ID
 *
 * @param tenantId - Tenant ID for multi-tenant isolation
 * @param tokenId - Token ID to retrieve
 * @returns Token detail with computed status (excludes tokenHash)
 * @throws {Error} If token not found or database error occurs
 *
 * Implementation:
 * 1. Execute within withTenantContext() for RLS enforcement
 * 2. Query api_tokens table by token_id and tenant_id
 * 3. If not found, throw error "Token not found"
 * 4. Compute status based on revoked_at and expires_at
 * 5. Exclude tokenHash from response (destructure and omit)
 * 6. Return token detail with status (without tokenHash)
 *
 * Security:
 * - Never returns plain text token (only token_prefix)
 * - Never returns tokenHash (internal verification secret)
 * - RLS ensures tenant isolation
 * - Status computed based on current timestamp
 */
export async function getToken(
  tenantId: string,
  tokenId: string
): Promise<TokenDetail> {
  // withTenantContext()å†…ã§DBæ“ä½œã‚’å®Ÿè¡Œ
  // SELECT * FROM api_tokens WHERE token_id = $1 AND tenant_id = $2
  // çµæœãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼: "Token not found"
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯:
  //   - revoked_at IS NOT NULL â†’ 'revoked'
  //   - expires_at IS NOT NULL AND expires_at <= NOW() â†’ 'expired'
  //   - ãã‚Œä»¥å¤– â†’ 'active'
  // tokenHashã‚’é™¤å¤–:
  //   const { tokenHash, ...tokenData } = result;
  //   return { ...tokenData, status };
}
```

### 2. APIãƒ«ãƒ¼ãƒˆå±¤ï¼ˆ`core/app/routes/api.tokens_.$id.ts`ï¼‰

#### 2.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼š`core/app/routes/api.tokens_.$id.ts`

Remix v2ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¦ç´„ã«ã‚ˆã‚Šã€`$id`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè‡ªå‹•çš„ã«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã€‚

#### 2.2 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜

**URL**: `GET /api/tokens/:id`

**èªè¨¼**: requireAuth()ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰

**URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `id` (string, required): ãƒˆãƒ¼ã‚¯ãƒ³IDï¼ˆUUIDå½¢å¼ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ï¼ˆ200 OKï¼‰:

```typescript
{
  tokenId: string;           // "123e4567-e89b-12d3-a456-426614174000"
  tenantId: string;          // "default"
  name: string;              // "GitHub Webhook Token"
  tokenPrefix: string;       // "drowltok_ABCDEFG" (first 16 chars for UI display)
  scopes: string[];          // ["webhook:write"]
  lastUsedAt: string | null; // "2025-01-15T10:30:00Z" (ISO 8601)
  expiresAt: string | null;  // "2025-12-31T23:59:59Z" (ISO 8601)
  createdBy: string;         // "user-uuid"
  createdAt: string;         // "2025-01-01T00:00:00Z" (ISO 8601)
  revokedAt: string | null;  // null or "2025-01-20T15:00:00Z" (ISO 8601)
  status: "active" | "expired" | "revoked";
}
```

**æ³¨æ„**: `tokenHash`ï¼ˆSHA256ãƒãƒƒã‚·ãƒ¥ï¼‰ã¯å†…éƒ¨æ¤œè¨¼ç”¨ã®ãŸã‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯**å«ã¾ã‚Œã¾ã›ã‚“**ã€‚

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

- `401 Unauthorized`: èªè¨¼ã•ã‚Œã¦ã„ãªã„
  ```json
  { "error": "Unauthorized" }
  ```

- `404 Not Found`: ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³
  ```json
  { "error": "Token not found" }
  ```

- `500 Internal Server Error`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
  ```json
  { "error": "Failed to fetch API token" }
  ```

#### 2.3 loaderé–¢æ•°å®Ÿè£…

```typescript
/**
 * GET /api/tokens/:id - Get API token detail
 */
export async function loader({ request, params }: LoaderFunctionArgs) {
  try {
    // 1. èªè¨¼ãƒã‚§ãƒƒã‚¯
    const user = await requireAuth(request);
    const tenantId = user.tenantId;

    // 2. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
    const tokenId = params.id;
    if (!tokenId) {
      return json({ error: 'Token ID is required' }, { status: 400 });
    }

    // 3. ã‚µãƒ¼ãƒ“ã‚¹å±¤å‘¼ã³å‡ºã—
    const token = await getToken(tenantId, tokenId);

    // 4. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return json(token, { status: 200 });
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
    // - requireAuth() redirect (302) â†’ 401 Unauthorized
    // - "Token not found" â†’ 404 Not Found
    // - ãã®ä»–ã®Error â†’ 500 Internal Server Error
  }
}
```

### 3. ãƒ†ã‚¹ãƒˆ

#### 3.1 ã‚µãƒ¼ãƒ“ã‚¹å±¤ãƒ†ã‚¹ãƒˆï¼ˆ`core/services/token.service.test.ts`ï¼‰

```typescript
describe('getToken()', () => {
  it('should return token detail with status "active"', async () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆæœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
    // getToken()å‘¼ã³å‡ºã—
    // çµæœæ¤œè¨¼: tokenId, name, tokenPrefix, status: 'active' ç­‰
  });

  it('should return token detail with status "expired"', async () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆæœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³: expires_at <= NOW()ï¼‰
    // getToken()å‘¼ã³å‡ºã—
    // çµæœæ¤œè¨¼: status: 'expired'
  });

  it('should return token detail with status "revoked"', async () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³: revoked_at IS NOT NULLï¼‰
    // getToken()å‘¼ã³å‡ºã—
    // çµæœæ¤œè¨¼: status: 'revoked'
  });

  it('should throw error if token not found', async () => {
    // å­˜åœ¨ã—ãªã„tokenIdã§å‘¼ã³å‡ºã—
    // ã‚¨ãƒ©ãƒ¼æ¤œè¨¼: "Token not found"
  });

  it('should not return tokens from other tenants (RLS)', async () => {
    // tenant1ã§ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆ
    // tenant2ã‹ã‚‰getToken()å‘¼ã³å‡ºã—
    // ã‚¨ãƒ©ãƒ¼æ¤œè¨¼: "Token not found" (RLSã«ã‚ˆã‚Šä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ãˆãªã„)
  });
});
```

#### 3.2 APIãƒ«ãƒ¼ãƒˆå±¤ãƒ†ã‚¹ãƒˆï¼ˆ`core/app/routes/api.tokens_.$id.test.ts`ï¼‰

```typescript
describe('GET /api/tokens/:id', () => {
  it('should return 200 with token detail for valid token', async () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    // GET /api/tokens/:id ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆèªè¨¼æ¸ˆã¿ï¼‰
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼: status 200, tokenId, name, status ç­‰
  });

  it('should return 404 if token not found', async () => {
    // å­˜åœ¨ã—ãªã„tokenIdã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼: status 404, error: "Token not found"
  });

  it('should return 401 if not authenticated', async () => {
    // èªè¨¼ãªã—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼: status 401, error: "Unauthorized"
  });

  it('should return 400 if token ID is missing', async () => {
    // params.idãŒundefinedã®å ´åˆï¼ˆé€šå¸¸ç™ºç”Ÿã—ãªã„ãŒã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼: status 400, error: "Token ID is required"
  });

  it('should not return tokens from other tenants', async () => {
    // tenant1ã§ãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆ
    // tenant2ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼: status 404, error: "Token not found"
  });
});
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†ç”»é¢ã§ãƒˆãƒ¼ã‚¯ãƒ³è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   â†“
2. GET /api/tokens/:id ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆCookieèªè¨¼ï¼‰
   â†“
3. loader()é–¢æ•°
   - requireAuth() â†’ user.tenantIdå–å¾—
   - params.idã‹ã‚‰tokenIdå–å¾—
   â†“
4. getToken(tenantId, tokenId)
   - withTenantContext()ã§RLSæœ‰åŠ¹åŒ–
   - SELECT * FROM api_tokens WHERE token_id = $1 AND tenant_id = $2
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ï¼ˆrevoked_at, expires_atã‚’åŸºã«ï¼‰
   â†“
5. JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
   - æˆåŠŸ: { tokenId, name, tokenPrefix, ..., status }
   - å¤±æ•—: { error: "Token not found" } (404)
```

## å®Ÿè£…ã®æ³¨æ„ç‚¹

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- ğŸš¨ **çµ¶å¯¾ã«ç”Ÿãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆtokenï¼‰ã‚’è¿”ã•ãªã„**
  - tokenPrefixã®ã¿è¿”ã™ï¼ˆUIè¡¨ç¤ºç”¨ï¼‰

- ğŸš¨ **çµ¶å¯¾ã«tokenHashã‚’è¿”ã•ãªã„**
  - SHA256ãƒãƒƒã‚·ãƒ¥ã¯æ¤œè¨¼ç”¨ã®ç§˜å¯†æƒ…å ±
  - ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã§ã®ã¿ä½¿ç”¨ï¼ˆverifyToken()ã§åˆ©ç”¨ï¼‰
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰é™¤å¤–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼ˆdestructuringã§é™¤å¤–ï¼‰

### å†…éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã¦ã¯ã„ã‘ãªã„ï¼‰:
- `tokenHash`: SHA256ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆæ¤œè¨¼ç”¨ã®ç§˜å¯†æƒ…å ±ã€ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã§ã®ã¿ä½¿ç”¨ï¼‰
- ãã®ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå®Ÿè£…æ™‚ã«è¿½åŠ ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å†…éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰

### 2. RLSï¼ˆRow Level Securityï¼‰

- `withTenantContext()`ã‚’å¿…ãšä½¿ç”¨
- PostgreSQLã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°`app.current_tenant_id`ã‚’è¨­å®š
- ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•çš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã‚‹

### 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

```typescript
let status: 'active' | 'expired' | 'revoked';

if (token.revokedAt !== null) {
  status = 'revoked';
} else if (token.expiresAt !== null && token.expiresAt <= new Date()) {
  status = 'expired';
} else {
  status = 'active';
}
```

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- `requireAuth()`ãŒthrowã™ã‚‹Response(302)ã‚’401ã«å¤‰æ›
- ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®"Token not found"ã‚¨ãƒ©ãƒ¼ã‚’404ã«å¤‰æ›
- ãã®ä»–ã®Errorã¯500ã«å¤‰æ›ï¼ˆè©³ç´°ã¯ãƒ­ã‚°ã«è¨˜éŒ²ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯è¿”ã•ãªã„ï¼‰

## å®Œäº†æ¡ä»¶

- [ ] `services/token.service.ts`ã«`getToken()`é–¢æ•°ã‚’å®Ÿè£…
- [ ] `app/routes/api.tokens_.$id.ts`ã‚’ä½œæˆã—ã€loaderé–¢æ•°ã‚’å®Ÿè£…
- [ ] `services/token.service.test.ts`ã«`getToken()`ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
- [ ] `app/routes/api.tokens_.$id.test.ts`ã‚’ä½œæˆã—ã€APIã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹
- [ ] TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹

## å‚è€ƒå®Ÿè£…

- `services/token.service.ts` - listTokens()ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- `app/routes/api.tokens.ts` - loaderé–¢æ•°ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³
- `db/schema/admin.ts` - apiTokensãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒ

## ä¾å­˜é–¢ä¿‚

- **å‰æ**: Task 8.17ï¼ˆAPIãƒˆãƒ¼ã‚¯ãƒ³ä½œæˆAPIï¼‰ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨
- **å¾Œç¶š**: Task 8.19ï¼ˆAPIãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–APIï¼‰ã§ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’åˆ©ç”¨
